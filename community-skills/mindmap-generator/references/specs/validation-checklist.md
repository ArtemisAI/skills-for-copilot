# 思维导图验证清单

## 概述

本文档定义了思维导图格式验证的完整清单，用于 `validate-mindmap.sh` 脚本的实现。

## 验证级别

- **错误 (Error)**: 必须修复，否则无法通过验证
- **警告 (Warning)**: 建议修复，不影响基本功能
- **信息 (Info)**: 提示性信息，可忽略

## 验证项目

### 1. 文件基本检查

#### 1.1 文件存在性
- **级别**: Error
- **代码**: E001
- **检查**: 文件是否存在且可读
- **错误信息**: "文件不存在或无法读取: {文件路径}"

#### 1.2 文件编码
- **级别**: Error
- **代码**: E002
- **检查**: 文件是否为 UTF-8 编码
- **错误信息**: "文件编码错误，必须使用 UTF-8 编码"
- **检测方法**: `file -b --mime-encoding {文件}`

#### 1.3 文件扩展名
- **级别**: Warning
- **代码**: W001
- **检查**: 文件扩展名是否为 .md
- **警告信息**: "建议使用 .md 作为文件扩展名"

#### 1.4 文件非空
- **级别**: Error
- **代码**: E003
- **检查**: 文件是否为空
- **错误信息**: "文件为空，无有效内容"

### 2. 标题层级检查

#### 2.1 根节点存在性
- **级别**: Error
- **代码**: E101
- **检查**: 文件必须以一级标题 (#) 开始
- **错误信息**: "文件必须以一级标题 (#) 开始"
- **检测方法**: 检查第一个非空行是否匹配 `^#\s+`

#### 2.2 根节点唯一性
- **级别**: Error
- **代码**: E102
- **检查**: 文件只能有一个一级标题
- **错误信息**: "文件只能有一个一级标题，发现 {数量} 个"
- **检测方法**: `grep -c "^#\s" {文件}`

#### 2.3 标题层级连续性
- **级别**: Error
- **代码**: E103
- **检查**: 标题层级不能跳级
- **错误信息**: "第 {行号} 行标题层级跳级: 从 {上级} 跳到 {当前级}"
- **示例**: 不能从 `##` 直接跳到 `####`
- **检测方法**: 逐行检查标题层级变化

#### 2.4 最大层级深度
- **级别**: Error
- **代码**: E104
- **检查**: 标题层级不能超过 6 级
- **错误信息**: "第 {行号} 行超出最大层级深度 (6)"
- **检测方法**: 检查 `^#{7,}\s`

#### 2.5 建议层级深度
- **级别**: Warning
- **代码**: W101
- **检查**: 建议标题层级不超过 5 级
- **警告信息**: "第 {行号} 行达到 6 级深度，建议不超过 5 级"
- **检测方法**: 检查 `^#{6}\s`

### 3. 标题格式检查

#### 3.1 标题格式规范
- **级别**: Error
- **代码**: E201
- **检查**: 标题 # 后必须有空格
- **错误信息**: "第 {行号} 行标题格式错误: # 后必须有空格"
- **正确**: `# 标题`
- **错误**: `#标题`
- **检测方法**: 检查 `^#+[^#\s]`

#### 3.2 标题非空
- **级别**: Error
- **代码**: E202
- **检查**: 标题内容不能为空
- **错误信息**: "第 {行号} 行标题为空"
- **检测方法**: 检查 `^#+\s*$`

#### 3.3 标题长度
- **级别**: Warning
- **代码**: W201
- **检查**: 标题建议不超过 50 个字符
- **警告信息**: "第 {行号} 行标题过长 ({长度} 字符)，建议不超过 50"
- **检测方法**: 计算标题文本长度

### 4. 内容结构检查

#### 4.1 单子节点检查
- **级别**: Warning
- **代码**: W301
- **检查**: 避免只有一个子节点的情况
- **警告信息**: "第 {行号} 行标题只有一个子节点，建议合并或增加"
- **检测方法**: 统计同级节点数量

#### 4.2 同级节点数量
- **级别**: Warning
- **代码**: W302
- **检查**: 建议同级节点数量不超过 7 个
- **警告信息**: "第 {行号} 行有 {数量} 个同级节点，建议不超过 7 个"
- **检测方法**: 统计同级节点数量

#### 4.3 节点内容长度
- **级别**: Warning
- **代码**: W303
- **检查**: 节点内容建议不超过 2 行
- **警告信息**: "第 {行号} 行节点内容过长，建议精简"
- **检测方法**: 计算标题下到下一个标题之间的行数

### 5. Markdown 语法检查

#### 5.1 代码块闭合
- **级别**: Error
- **代码**: E301
- **检查**: 代码块必须正确闭合
- **错误信息**: "代码块未正确闭合，从第 {行号} 行开始"
- **检测方法**: 统计 ``` 数量是否为偶数

#### 5.2 列表格式
- **级别**: Warning
- **代码**: W401
- **检查**: 列表项格式是否规范
- **警告信息**: "第 {行号} 行列表格式建议: 使用 - 或 1. 开头，后接空格"
- **检测方法**: 检查列表项格式

#### 5.3 链接格式
- **级别**: Warning
- **代码**: W402
- **检查**: Markdown 链接格式是否正确
- **警告信息**: "第 {行号} 行链接格式可能有误"
- **检测方法**: 检查 `[text](url)` 格式

### 6. 内容质量检查

#### 6.1 空白标题节点
- **级别**: Warning
- **代码**: W501
- **检查**: 标题下是否有内容或子标题
- **警告信息**: "第 {行号} 行标题下无内容且无子节点"
- **检测方法**: 检查标题后是否有内容

#### 6.2 重复标题
- **级别**: Info
- **代码**: I501
- **检查**: 同级标题是否重复
- **提示信息**: "发现重复的同级标题: {标题文本}"
- **检测方法**: 统计同级标题文本

#### 6.3 标题语气一致性
- **级别**: Info
- **代码**: I502
- **检查**: 同级标题表达风格是否一致
- **提示信息**: "同级标题表达风格建议保持一致"
- **检测方法**: 启发式检查（疑问句、陈述句混用等）

## 验证流程

### 第一阶段: 基本检查
1. 文件存在性检查
2. 文件编码检查
3. 文件非空检查

如有错误，停止后续检查。

### 第二阶段: 结构检查
1. 根节点检查
2. 标题层级检查
3. 标题格式检查

如有严重错误，停止后续检查。

### 第三阶段: 质量检查
1. 内容结构检查
2. Markdown 语法检查
3. 内容质量检查

收集所有警告和信息。

### 第四阶段: 生成报告
1. 统计错误、警告、信息数量
2. 按级别和位置排序输出
3. 给出修复建议
4. 返回退出码

## 退出码定义

- `0`: 验证通过（可能有警告或信息）
- `1`: 验证失败（存在错误）
- `2`: 文件无法读取或处理

## 输出格式

### 成功示例

```
✅ 验证通过: mindmap.md

统计信息:
  总行数: 230
  标题数: 45
  最大层级: 5

质量建议:
  ⚠️ W302: 第 15 行有 8 个同级节点，建议不超过 7 个
  ℹ️ I501: 发现重复的同级标题: "核心特征"

总计: 0 错误, 1 警告, 1 信息
```

### 失败示例

```
❌ 验证失败: mindmap.md

错误详情:
  ❌ E103: 第 23 行标题层级跳级: 从 ## 跳到 ####
  ❌ E201: 第 45 行标题格式错误: # 后必须有空格

警告信息:
  ⚠️ W101: 第 67 行达到 6 级深度，建议不超过 5 级

总计: 2 错误, 1 警告, 0 信息

请修复所有错误后重新验证。
```

## 验证脚本使用

### 基本用法

```bash
./scripts/validate-mindmap.sh <文件路径>
```

### 参数选项

```bash
-h, --help          显示帮助信息
-v, --verbose       详细输出模式
-q, --quiet         只显示错误
-s, --strict        严格模式（警告视为错误）
--no-color          禁用颜色输出
```

### 使用示例

```bash
# 基本验证
./scripts/validate-mindmap.sh mindmap.md

# 详细模式
./scripts/validate-mindmap.sh -v mindmap.md

# 严格模式（CI/CD 使用）
./scripts/validate-mindmap.sh -s mindmap.md

# 批量验证
find . -name "*.md" -exec ./scripts/validate-mindmap.sh {} \;
```

## 自定义规则

可以通过配置文件自定义验证规则（未来功能）：

```yaml
# .mindmap-lint.yml
rules:
  max-heading-level: 5
  max-siblings: 7
  max-title-length: 50
  allow-single-child: false
  enforce-utf8: true
```

## 常见问题

### Q1: 如何修复层级跳级？
A: 补充中间层级标题，或调整子标题层级。

### Q2: 如何处理单子节点？
A: 将单子节点合并到父节点，或增加同级节点。

### Q3: 节点内容过长怎么办？
A: 提取关键词作为标题，详细内容放到子节点。

### Q4: UTF-8 编码如何确保？
A: 使用支持 UTF-8 的编辑器，保存时选择 UTF-8 编码。

## 参考资源

- 格式规范: @mindmap-format-rules.md
- 质量标准: @quality-criteria.md
- 验证脚本: @../../scripts/validate-mindmap.sh
